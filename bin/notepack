#!/bin/bash

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done

# Real directory the file exists
DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Path to script files
SCRIPTS_PATH="$DIR/../src"

# Filepath for active watch process monitoring
WATCHING_PATH="$DIR/../.WATCHING"

is_configured () {
  if [ -f "$HOME/.notepack_config" ]
    then return 0
    else
      echo -e "Please configure your Notepack first by running \x1b[1;33m\x1b[1mnotepack configure\x1b[0m"
      return 1
  fi
}

is_watching () {
  if [ -f $WATCHING_PATH ]
    then return 0
    else return 1
  fi
}

start_watching () {
  node $SCRIPTS_PATH/watch.js --background > /dev/null &
  disown
  echo -n $! >> $WATCHING_PATH
  echo -e "\x1b[0;34mWatching notes in the background (pid: $!)...\x1b[0m"
}

stop_watching () {
  if is_watching
    then
      echo -e "\x1b[0;34mNo longer watching notes in the background\x1b[0m"
      kill $(< $WATCHING_PATH)
    else
      echo -e "Not watching notes in the background"
  fi
}

todos () {
  if [ $1 ]
    then
      node $SCRIPTS_PATH/todos.js --asignedTo $1
    else
      node $SCRIPTS_PATH/todos.js
  fi
}

update() {
  node $SCRIPTS_PATH/updateTodos.js
}

watch() {
  if is_watching
    then
      if ps -p $(< $WATCHING_PATH) > /dev/null
        then
          echo -e "\x1b[0;31mAlready watching (pid: $(< $WATCHING_PATH))...\x1b[0m"
        else
          rm $WATCHING_PATH
          start_watching
      fi
    else
      start_watching
  fi
}

case "$1" in
"configure")
  node $SCRIPTS_PATH/configure.js
  ;;
"stop")
  if is_configured; then stop_watching; fi
  ;;
"todos")
  if is_configured; then todos $2; fi
  ;;
"update")
  if is_configured; then update; fi
  ;;
"watch")
  if is_configured; then watch; fi
  ;;
*)
  if is_configured; then todos; fi
  ;;
esac
